<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSC44NDPLQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LSC44NDPLQ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Studio GitHub Copilot Lab</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="step.css">
    <link rel="stylesheet" href="light-theme.css">
    <script src="theme-toggle.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="header-brand">
                <span>üöÄ</span>
                <span class="header-title">VS GitHub Copilot Lab</span>
            </a>
            <nav class="header-nav">
                <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
                <button class="nav-btn" id="prevBtn" disabled>‚Üê Previous</button>
                <button class="nav-btn" id="nextBtn">Next ‚Üí</button>
            </nav>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Workshop Steps</div>
                <nav id="stepNav"></nav>
            </div>
        </aside>

        <main class="main">
            <article class="content">
                <div id="markdown-content" class="markdown">
                    <div class="loading">Loading content</div>
                </div>
                <nav class="nav-footer">
                    <a href="#" class="nav-footer-btn disabled" id="prevLink">‚Üê Previous</a>
                    <a href="#" class="nav-footer-btn" id="nextLink">Next ‚Üí</a>
                </nav>
            </article>
        </main>
    </div>

    <script>
        // Define all steps in order
        const steps = [
            { id: 'setup', file: 'setup.md', title: 'Setup & Configuration', number: '00' },
            { id: 'part00-exploring-codebase', file: 'part00-exploring-codebase.md', title: 'Exploring the Codebase', number: '01' },
            { id: 'part01-code-completion', file: 'part01-code-completion.md', title: 'Code Completion', number: '02' },
            { id: 'part02-enhancing-ui', file: 'part02-enhancing-ui.md', title: 'Enhancing UI', number: '03' },
            { id: 'part03-referencing-files', file: 'part03-referencing-files.md', title: 'Referencing Files', number: '04' },
            { id: 'part04-custom-instructions', file: 'part04-custom-instructions.md', title: 'Custom Instructions', number: '05' },
            { id: 'part05-implementing-features', file: 'part05-implementing-features.md', title: 'Agent Mode', number: '06' },
            { id: 'part06-copilot-vision', file: 'part06-copilot-vision.md', title: 'Copilot Vision', number: '07' },
            { id: 'part07-debugging-with-copilot', file: 'part07-debugging-with-copilot.md', title: 'Debugging', number: '08' },
            { id: 'part08-commit-summary-descriptions', file: 'part08-commit-summary-descriptions.md', title: 'Commit Summaries', number: '09' },
            { id: 'part09-mcp', file: 'part09-mcp.md', title: 'MCP Servers', number: '10' },
            { id: 'part10-planning-mode', file: 'part10-planning-mode.md', title: 'Planning Mode', number: '11' },
            { id: 'part11-reusable-prompts', file: 'part11-reusable-prompts.md', title: 'Prompt Files', number: '12' },
            { id: 'part12-delegate-to-cloud', file: 'part12-delegate-to-cloud.md', title: 'Cloud Delegation', number: '13' },
        ];

        // Get current step from URL
        function getCurrentStepId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('step') || 'setup';
        }

        function getCurrentStepIndex() {
            const stepId = getCurrentStepId();
            return steps.findIndex(s => s.id === stepId);
        }

        // Build sidebar navigation
        function buildSidebar() {
            const nav = document.getElementById('stepNav');
            const currentId = getCurrentStepId();
            
            nav.innerHTML = steps.map(step => `
                <a href="?step=${step.id}" class="step-link ${step.id === currentId ? 'active' : ''}">
                    <span class="step-number">${step.number}</span>
                    <span>${step.title}</span>
                </a>
            `).join('');
        }

        // Update navigation buttons
        function updateNavigation() {
            const idx = getCurrentStepIndex();
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const prevLink = document.getElementById('prevLink');
            const nextLink = document.getElementById('nextLink');

            // Header buttons
            prevBtn.disabled = idx <= 0;
            nextBtn.disabled = idx >= steps.length - 1;

            prevBtn.onclick = () => idx > 0 && (window.location.search = `?step=${steps[idx - 1].id}`);
            nextBtn.onclick = () => idx < steps.length - 1 && (window.location.search = `?step=${steps[idx + 1].id}`);

            // Footer links
            if (idx > 0) {
                prevLink.href = `?step=${steps[idx - 1].id}`;
                prevLink.textContent = `‚Üê ${steps[idx - 1].title}`;
                prevLink.classList.remove('disabled');
            } else {
                prevLink.classList.add('disabled');
                prevLink.textContent = '‚Üê Previous';
            }

            if (idx < steps.length - 1) {
                nextLink.href = `?step=${steps[idx + 1].id}`;
                nextLink.textContent = `${steps[idx + 1].title} ‚Üí`;
                nextLink.classList.remove('disabled');
            } else {
                // Last step - link to completion page
                nextLink.href = 'complete.html';
                nextLink.textContent = 'üéâ Complete Workshop!';
                nextLink.classList.remove('disabled');
                nextLink.style.background = 'linear-gradient(135deg, var(--neon-cyan), var(--neon-purple))';
            }
        }

        // Process markdown - fix image paths and handle special syntax
        function processMarkdown(md) {
            // Fix image paths - images are in lab/images/
            md = md.replace(/!\[([^\]]*)\]\(\.\/images\//g, '![$1](lab/images/');
            md = md.replace(/!\[([^\]]*)\]\(images\//g, '![$1](lab/images/');
            
            // Convert GitHub-style checkboxes: 1. [] becomes checkbox
            md = md.replace(/^(\d+)\.\s*\[\s*\]\s*/gm, '$1. <input type="checkbox"> ');
            
            // Handle GitHub alerts: [!NOTE], [!TIP], [!IMPORTANT], [!WARNING], [!CAUTION]
            md = md.replace(/> \[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]\s*\n((?:> .*(?:\n|$))*)/gi, function(match, type, content) {
                const cleanContent = content.replace(/^> ?/gm, '').trim();
                const icons = { NOTE: '‚ÑπÔ∏è', TIP: 'üí°', IMPORTANT: '‚ùó', WARNING: '‚ö†Ô∏è', CAUTION: 'üî¥' };
                const colors = { NOTE: 'var(--neon-cyan)', TIP: 'var(--success-green)', IMPORTANT: 'var(--neon-purple)', WARNING: 'var(--warning-yellow)', CAUTION: '#ff6b6b' };
                const icon = icons[type.toUpperCase()] || '‚ÑπÔ∏è';
                const color = colors[type.toUpperCase()] || 'var(--neon-cyan)';
                return `<blockquote style="border-left-color: ${color};"><p style="color: ${color};">${icon} ${type.toUpperCase()}</p><p>${cleanContent}</p></blockquote>\n`;
            });

            // Remove navigation links at the bottom (we have our own)
            md = md.replace(/---\s*\n\s*\[Back:.*$/s, '');
            md = md.replace(/---\s*\n\s*\[Next:.*$/s, '');

            return md;
        }

        // Load and render markdown
        async function loadContent() {
            const idx = getCurrentStepIndex();
            if (idx === -1) {
                document.getElementById('markdown-content').innerHTML = '<p>Step not found. <a href="?step=setup">Go to Setup</a></p>';
                return;
            }

            const step = steps[idx];
            document.title = `${step.title} | VS GitHub Copilot Lab`;

            try {
                // Fetch markdown from lab folder (copied to docs/lab during deploy)
                const response = await fetch(`lab/${step.file}`);
                if (!response.ok) throw new Error('Failed to load');
                
                let md = await response.text();
                md = processMarkdown(md);
                
                // Configure marked
                marked.setOptions({
                    breaks: true,
                    gfm: true
                });

                document.getElementById('markdown-content').innerHTML = marked.parse(md);

                // Fire confetti on last step
                if (idx === steps.length - 1 && typeof confetti === 'function') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            } catch (error) {
                document.getElementById('markdown-content').innerHTML = `
                    <h1>Error Loading Content</h1>
                    <p>Could not load ${step.file}. Please check that the file exists.</p>
                    <p><a href="index.html">Return to home</a></p>
                `;
            }
        }

        // Initialize
        buildSidebar();
        updateNavigation();
        loadContent();

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            const idx = getCurrentStepIndex();
            if (e.key === 'ArrowLeft' && idx > 0) {
                window.location.search = `?step=${steps[idx - 1].id}`;
            } else if (e.key === 'ArrowRight' && idx < steps.length - 1) {
                window.location.search = `?step=${steps[idx + 1].id}`;
            }
        });
    </script>
</body>
</html>
